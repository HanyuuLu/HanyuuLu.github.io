{"title":"Sentinel开源版接入InfluxDB数据持久化并使用Grafana可视化","date":"2021-01-22T00:00:00.000Z","link":"SentinelInfluxDB改造","tags":["Grafana","InfluxDB","Sentinel"],"updated":"2021-03-12T08:22:58.450Z","content":"<p>[toc]</p>\n<h1 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"SentinelInfluxDB改造#前言\"></a> 前言<a href=\"SentinelInfluxDB改造#前言\"></a></h1>\n<p><a href=\"https://github.com/alibaba/Sentinel\" target=\"_blank\" rel=\"noopener\">Sentinel开源版本</a>流量数据保存在内存中，有效期为最近5min，为了能让数据持久化保存并进行中长期分析，参照了一些文章，我们对Sentinel-dashboard流量数据进行改造、接入InfluxDB。</p>\n<blockquote>\n<p>为了阅读上更直观，本文里所有URL已做反转义处理，另，host名为杜撰，改造时请自行带入实际的hostname或ip</p>\n</blockquote>\n<h2 id=\"准备工作\"><a class=\"markdownIt-Anchor\" href=\"SentinelInfluxDB改造#准备工作\"></a> 准备工作<a href=\"SentinelInfluxDB改造#准备工作\"></a></h2>\n<ol>\n<li>\n<p>Sentinel<a href=\"https://github.com/alibaba/Sentinel\" target=\"_blank\" rel=\"noopener\">源代码</a></p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git pull git@github.com:alibaba/Sentinel.git</span><br></pre></td></tr></table></div></figure>\n</li>\n<li>\n<p>InfluxDB 1.8 Docker镜像</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull influxdb:latest</span><br><span class=\"line\"><span class=\"comment\"># 笔者从DockerHub拉取时最新的镜像版本为1.8.3，如2.x版本无法使用请使用下方拉取1.8.3版本</span></span><br><span class=\"line\">docker pull influxdb:1.8.3</span><br></pre></td></tr></table></div></figure>\n</li>\n</ol>\n<h1 id=\"接入influxdb\"><a class=\"markdownIt-Anchor\" href=\"SentinelInfluxDB改造#接入influxdb\"></a> 接入InfluxDB<a href=\"SentinelInfluxDB改造#接入influxdb\"></a></h1>\n<ol>\n<li>SentinelDB环境准备</li>\n</ol>\n<blockquote>\n<p>安装和权限配置本文不再展开，详细请参阅<a href=\"https://hanyuu.icu/InfluxDB%20%E9%85%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%EF%BC%88Docker%EF%BC%89\" target=\"_blank\" rel=\"noopener\">create database sentinel_db</a></p>\n</blockquote>\n<p>创建数据库以备使用，在influx命令行或者HTTP调用中</p>\n<ul>\n<li>cli</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; create database sentinel_db</span><br></pre></td></tr></table></div></figure>\n<ul>\n<li>HTTP call</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[POST] http://influxdb.idc.hanyuu.demo:8086/query?q=create database sentinel_db</span><br></pre></td></tr></table></div></figure>\n<ol start=\"2\">\n<li>\n<p>在<code>pom.xml</code>中、添加InfluxDB和Lombok（简化开发流程）依赖</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    lqlu03</span></span><br><span class=\"line\"><span class=\"comment\">    使用infulxdb作为数据持久化数据库</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.influxdb<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>influxdb-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.17<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.projectlombok<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>lombok<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.18.16<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">scope</span>&gt;</span>provided<span class=\"tag\">&lt;/<span class=\"name\">scope</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>\n</li>\n<li>\n<p>添加数据库工具类</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.alibaba.csp.sentinel.dashboard.util;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.List;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.AllArgsConstructor;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Getter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.InfluxDB;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.InfluxDBFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.dto.BoundParameterQuery;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.dto.QueryResult;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.impl.InfluxDBResultMapper;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Component;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> HanyuuLu</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020-01-14</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * Sentinel</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@AllArgsConstructor</span></span><br><span class=\"line\"><span class=\"meta\">@Slf</span>4j</span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">InfluxDBUtils</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String url;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String username;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String password;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> InfluxDBResultMapper resultMapper = <span class=\"keyword\">new</span> InfluxDBResultMapper();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Value</span>(<span class=\"string\">\"$&#123;influxdb.url&#125;\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setUrl</span><span class=\"params\">(String url)</span> </span>&#123;</span><br><span class=\"line\">        InfluxDBUtils.url = url;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Value</span>(<span class=\"string\">\"$&#123;influxdb.username&#125;\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setUsername</span><span class=\"params\">(String username)</span> </span>&#123;</span><br><span class=\"line\">        InfluxDBUtils.username = username;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Value</span>(<span class=\"string\">\"$&#123;influxdb.password&#125;\"</span>)</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setPassword</span><span class=\"params\">(String password)</span> </span>&#123;</span><br><span class=\"line\">        InfluxDBUtils.password = password;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">T <span class=\"title\">process</span><span class=\"params\">(String database, InfluxDBCallback callback)</span> </span>&#123;</span><br><span class=\"line\">        InfluxDB influxDb = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        T t = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            influxDb = InfluxDBFactory.connect(url, username, password);</span><br><span class=\"line\">            influxDb.setDatabase(database);</span><br><span class=\"line\"></span><br><span class=\"line\">            t = callback.doCallBack(database, influxDb);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">\"[process exception]\"</span>, e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (influxDb != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    influxDb.close();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                    log.error(<span class=\"string\">\"[influxDB.close exception]\"</span>, e);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> t;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">insert</span><span class=\"params\">(String database, InfluxDBInsertCallback influxDBInsertCallback)</span> </span>&#123;</span><br><span class=\"line\">        process(database, <span class=\"keyword\">new</span> InfluxDBCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> &lt;T&gt; <span class=\"function\">T <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span> </span>&#123;</span><br><span class=\"line\">                influxDBInsertCallback.doCallBack(database, influxDB);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> QueryResult <span class=\"title\">query</span><span class=\"params\">(String database, InfluxDBQueryCallback influxDBQueryCallback)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> process(database, <span class=\"keyword\">new</span> InfluxDBCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"keyword\">public</span> &lt;T&gt; <span class=\"function\">T <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span> </span>&#123;</span><br><span class=\"line\">                QueryResult queryResult = influxDBQueryCallback.doCallBack(database, influxDB);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> (T) queryResult;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">List&lt;T&gt; <span class=\"title\">queryList</span><span class=\"params\">(String database, String sql, Map&lt;String, Object&gt; paramMap, Class&lt;T&gt; clasz)</span> </span>&#123;</span><br><span class=\"line\">        QueryResult queryResult = query(database, <span class=\"keyword\">new</span> InfluxDBQueryCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> QueryResult <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span> </span>&#123;</span><br><span class=\"line\">                BoundParameterQuery.QueryBuilder queryBuilder = BoundParameterQuery.QueryBuilder.newQuery(sql);</span><br><span class=\"line\">                queryBuilder.forDatabase(database);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (paramMap != <span class=\"keyword\">null</span> &amp;&amp; paramMap.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    Set&lt;Map.Entry&lt;String, Object&gt;&gt; entries = paramMap.entrySet();</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (Map.Entry&lt;String, Object&gt; entry : entries) &#123;</span><br><span class=\"line\">                        queryBuilder.bind(entry.getKey(), entry.getValue());</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> influxDB.query(queryBuilder.create());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> resultMapper.toPOJO(queryResult, clasz);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">InfluxDBCallback</span> </span>&#123;</span><br><span class=\"line\">        &lt;T&gt; <span class=\"function\">T <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span></span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">InfluxDBInsertCallback</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span></span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">InfluxDBQueryCallback</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\">QueryResult <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span></span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n</li>\n</ol>\n<p>url、username、password用于存储InfluxDB的连接、用户名、密码信息，定义为static属性，因此在set方法上使用@Value注解从配置文件读取属性值；</p>\n<ul>\n<li>\n<p>resultMapper用于查询结果到实体类的映射；</p>\n</li>\n<li>\n<p>init方法用于初始化url、username、password；</p>\n</li>\n<li>\n<p>process为通用的处理方法，负责打开关闭连接，并且调用InfluxDBCallback回调方法；</p>\n</li>\n<li>\n<p>insert为插入数据方法，配合InfluxDBInsertCallback回调使用；</p>\n</li>\n<li>\n<p>query为通用的查询方法，配合InfluxDBQueryCallback回调方法使用，返回QueryResult对象；</p>\n</li>\n<li>\n<p>queryList为查询列表方法，调用query得到QueryResult，再通过resultMapper转换为List&lt;实体类&gt;;</p>\n</li>\n</ul>\n<p>在resources目录下的application.properties文件中，增加InfluxDB的配置：</p>\n  <figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">influxdb.url</span>=<span class=\"string\">http://influxdb.idc.hanyuu.demo:8086</span></span><br><span class=\"line\"><span class=\"meta\">influxdb.username</span>=<span class=\"string\">username</span></span><br><span class=\"line\"><span class=\"meta\">influxdb.password</span>=<span class=\"string\">p@ssw0rd</span></span><br></pre></td></tr></table></div></figure>\n<ol start=\"4\">\n<li>\n<p>添加实体类</p>\n <figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.alibaba.csp.sentinel.dashboard.datasource.entity.InfluxDb;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.time.Instant;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.annotation.Column;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.annotation.Measurement;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> HanyuuLu</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020-01-14</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@Measurement</span>(name = <span class=\"string\">\"sentinel_metric\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MetricPO</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"time\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Instant time;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"id\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long id;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"gmtCreate\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long gmtCreate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"gmtModified\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long gmtModified;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"app\"</span>, tag = <span class=\"keyword\">true</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String app;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"resource\"</span>, tag = <span class=\"keyword\">true</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String resource;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"passQps\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long passQps;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"successQps\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long successQps;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"blockQps\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long blockQps;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"exceptionQps\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Long exceptionQps;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"rt\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">double</span> rt;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"count\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> count;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Column</span>(name = <span class=\"string\">\"resourceCode\"</span>)</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> resourceCode;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>该类参考MetricEntity创建，加上influxdb-java包提供的注解，通过@Measurement(name = “sentinel_metric”)指定数据表(measurement)名称，</p>\n<p>time作为时序数据库的时间列；</p>\n<p>app、resource设置为tag列，通过注解标识为tag=true；</p>\n<p>其它字段为filed列；</p>\n</li>\n<li>\n<p>实现<code>MetricsRepository</code>接口</p>\n</li>\n</ol>\n<p>在如下package中，找到接口<code>public interface MetricsRepository&lt;T&gt;</code>,这是一个关于指标数据保存和应用信息查询的借口，我们从这里重写方法以保存到InfluxDB。</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.alibaba.csp.sentinel.dashboard.repository.metric;</span><br></pre></td></tr></table></div></figure>\n<p>对接口重新进行实现</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.alibaba.csp.sentinel.dashboard.repository.metric;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.csp.sentinel.util.StringUtil;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.csp.sentinel.dashboard.datasource.entity.MetricEntity;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.csp.sentinel.dashboard.datasource.entity.InfluxDb.MetricPO;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.csp.sentinel.dashboard.util.InfluxDBUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.lang.time.DateFormatUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.lang.time.DateUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.InfluxDB;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.influxdb.dto.Point;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.stereotype.Repository;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.CollectionUtils;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.*;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.TimeUnit;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * metrics数据InfluxDB存储实现</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> HanyuuLu</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020-01-14</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Repository</span>(<span class=\"string\">\"influxDBMetricsRepository\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">InfluxDBMetricsRepository</span> <span class=\"keyword\">implements</span> <span class=\"title\">MetricsRepository</span>&lt;<span class=\"title\">MetricEntity</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**时间格式*/</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String DATE_FORMAT_PATTERN = <span class=\"string\">\"yyyy-MM-dd HH:mm:ss.SSS\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**数据库名称*/</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SENTINEL_DATABASE = <span class=\"string\">\"sentinel_db\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**数据表名称*/</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String METRIC_MEASUREMENT = <span class=\"string\">\"sentinel_metric\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**北京时间领先UTC时间8小时 UTC: Universal Time Coordinated,世界统一时间*/</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Integer UTC_8 = <span class=\"number\">8</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">save</span><span class=\"params\">(MetricEntity metric)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (metric == <span class=\"keyword\">null</span> || StringUtil.isBlank(metric.getApp())) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        InfluxDBUtils.insert(SENTINEL_DATABASE, <span class=\"keyword\">new</span> InfluxDBUtils.InfluxDBInsertCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (metric.getId() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    metric.setId(System.currentTimeMillis());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                doSave(influxDB, metric);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">saveAll</span><span class=\"params\">(Iterable&lt;MetricEntity&gt; metrics)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (metrics == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Iterator&lt;MetricEntity&gt; iterator = metrics.iterator();</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> next = iterator.hasNext();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!next) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        InfluxDBUtils.insert(SENTINEL_DATABASE, <span class=\"keyword\">new</span> InfluxDBUtils.InfluxDBInsertCallback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">doCallBack</span><span class=\"params\">(String database, InfluxDB influxDB)</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (iterator.hasNext()) &#123;</span><br><span class=\"line\">                    MetricEntity metric = iterator.next();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (metric.getId() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        metric.setId(System.currentTimeMillis());</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    doSave(influxDB, metric);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;MetricEntity&gt; <span class=\"title\">queryByAppAndResourceBetween</span><span class=\"params\">(String app, String resource, <span class=\"keyword\">long</span> startTime, <span class=\"keyword\">long</span> endTime)</span> </span>&#123;</span><br><span class=\"line\">        List&lt;MetricEntity&gt; results = <span class=\"keyword\">new</span> ArrayList&lt;MetricEntity&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtil.isBlank(app)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> results;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtil.isBlank(resource)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> results;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        StringBuilder sql = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">        sql.append(<span class=\"string\">\"SELECT * FROM \"</span> + METRIC_MEASUREMENT);</span><br><span class=\"line\">        sql.append(<span class=\"string\">\" WHERE app=$app\"</span>);</span><br><span class=\"line\">        sql.append(<span class=\"string\">\" AND resource=$resource\"</span>);</span><br><span class=\"line\">        sql.append(<span class=\"string\">\" AND time&gt;=$startTime\"</span>);</span><br><span class=\"line\">        sql.append(<span class=\"string\">\" AND time&lt;=$endTime\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, Object&gt; paramMap = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">        paramMap.put(<span class=\"string\">\"app\"</span>, app);</span><br><span class=\"line\">        paramMap.put(<span class=\"string\">\"resource\"</span>, resource);</span><br><span class=\"line\">        paramMap.put(<span class=\"string\">\"startTime\"</span>, DateFormatUtils.format(<span class=\"keyword\">new</span> Date(startTime), DATE_FORMAT_PATTERN));</span><br><span class=\"line\">        paramMap.put(<span class=\"string\">\"endTime\"</span>, DateFormatUtils.format(<span class=\"keyword\">new</span> Date(endTime), DATE_FORMAT_PATTERN));</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;MetricPO&gt; metricPOS = InfluxDBUtils.queryList(SENTINEL_DATABASE, sql.toString(), paramMap, MetricPO<span class=\"class\">.<span class=\"keyword\">class</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (CollectionUtils.isEmpty(metricPOS)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> results;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MetricPO metricPO : metricPOS) &#123;</span><br><span class=\"line\">            results.add(convertToMetricEntity(metricPO));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> results;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;String&gt; <span class=\"title\">listResourcesOfApp</span><span class=\"params\">(String app)</span> </span>&#123;</span><br><span class=\"line\">        List&lt;String&gt; results = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (StringUtil.isBlank(app)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> results;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        StringBuilder sql = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">        sql.append(<span class=\"string\">\"SELECT * FROM \"</span> + METRIC_MEASUREMENT);</span><br><span class=\"line\">        sql.append(<span class=\"string\">\" WHERE app=$app\"</span>);</span><br><span class=\"line\">        sql.append(<span class=\"string\">\" AND time&gt;=$startTime\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, Object&gt; paramMap = <span class=\"keyword\">new</span> HashMap&lt;String, Object&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">long</span> startTime = System.currentTimeMillis() - <span class=\"number\">1000</span> * <span class=\"number\">60</span>;</span><br><span class=\"line\">        paramMap.put(<span class=\"string\">\"app\"</span>, app);</span><br><span class=\"line\">        paramMap.put(<span class=\"string\">\"startTime\"</span>, DateFormatUtils.format(<span class=\"keyword\">new</span> Date(startTime), DATE_FORMAT_PATTERN));</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;MetricPO&gt; metricPOS = InfluxDBUtils.queryList(SENTINEL_DATABASE, sql.toString(), paramMap, MetricPO<span class=\"class\">.<span class=\"keyword\">class</span>)</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (CollectionUtils.isEmpty(metricPOS)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> results;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        List&lt;MetricEntity&gt; metricEntities = <span class=\"keyword\">new</span> ArrayList&lt;MetricEntity&gt;();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MetricPO metricPO : metricPOS) &#123;</span><br><span class=\"line\">            metricEntities.add(convertToMetricEntity(metricPO));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Map&lt;String, MetricEntity&gt; resourceCount = <span class=\"keyword\">new</span> HashMap&lt;&gt;(<span class=\"number\">32</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (MetricEntity metricEntity : metricEntities) &#123;</span><br><span class=\"line\">            String resource = metricEntity.getResource();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (resourceCount.containsKey(resource)) &#123;</span><br><span class=\"line\">                MetricEntity oldEntity = resourceCount.get(resource);</span><br><span class=\"line\">                oldEntity.addPassQps(metricEntity.getPassQps());</span><br><span class=\"line\">                oldEntity.addRtAndSuccessQps(metricEntity.getRt(), metricEntity.getSuccessQps());</span><br><span class=\"line\">                oldEntity.addBlockQps(metricEntity.getBlockQps());</span><br><span class=\"line\">                oldEntity.addExceptionQps(metricEntity.getExceptionQps());</span><br><span class=\"line\">                oldEntity.addCount(<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                resourceCount.put(resource, MetricEntity.copyOf(metricEntity));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Order by last minute b_qps DESC.</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> resourceCount.entrySet()</span><br><span class=\"line\">                .stream()</span><br><span class=\"line\">                .sorted((o1, o2) -&gt; &#123;</span><br><span class=\"line\">                    MetricEntity e1 = o1.getValue();</span><br><span class=\"line\">                    MetricEntity e2 = o2.getValue();</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> t = e2.getBlockQps().compareTo(e1.getBlockQps());</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (t != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> t;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> e2.getPassQps().compareTo(e1.getPassQps());</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">                .map(Map.Entry::getKey)</span><br><span class=\"line\">                .collect(Collectors.toList());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> MetricEntity <span class=\"title\">convertToMetricEntity</span><span class=\"params\">(MetricPO metricPO)</span> </span>&#123;</span><br><span class=\"line\">        MetricEntity metricEntity = <span class=\"keyword\">new</span> MetricEntity();</span><br><span class=\"line\"></span><br><span class=\"line\">        metricEntity.setId(metricPO.getId());</span><br><span class=\"line\">        metricEntity.setGmtCreate(<span class=\"keyword\">new</span> Date(metricPO.getGmtCreate()));</span><br><span class=\"line\">        metricEntity.setGmtModified(<span class=\"keyword\">new</span> Date(metricPO.getGmtModified()));</span><br><span class=\"line\">        metricEntity.setApp(metricPO.getApp());</span><br><span class=\"line\">        metricEntity.setTimestamp(Date.from(metricPO.getTime().minusMillis(TimeUnit.HOURS.toMillis(UTC_8))));</span><br><span class=\"line\">        metricEntity.setResource(metricPO.getResource());</span><br><span class=\"line\">        metricEntity.setPassQps(metricPO.getPassQps());</span><br><span class=\"line\">        metricEntity.setSuccessQps(metricPO.getSuccessQps());</span><br><span class=\"line\">        metricEntity.setBlockQps(metricPO.getBlockQps());</span><br><span class=\"line\">        metricEntity.setExceptionQps(metricPO.getExceptionQps());</span><br><span class=\"line\">        metricEntity.setRt(metricPO.getRt());</span><br><span class=\"line\">        metricEntity.setCount(metricPO.getCount());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> metricEntity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doSave</span><span class=\"params\">(InfluxDB influxDB, MetricEntity metric)</span> </span>&#123;</span><br><span class=\"line\">        influxDB.write(Point.measurement(METRIC_MEASUREMENT)</span><br><span class=\"line\">                .time(DateUtils.addHours(metric.getTimestamp(), UTC_8).getTime(), TimeUnit.MILLISECONDS)<span class=\"comment\">// UTC -&gt; Shanghai(UTC+8) time zone.</span></span><br><span class=\"line\">                .tag(<span class=\"string\">\"app\"</span>, metric.getApp())</span><br><span class=\"line\">                .tag(<span class=\"string\">\"resource\"</span>, metric.getResource())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"id\"</span>, metric.getId())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"gmtCreate\"</span>, metric.getGmtCreate().getTime())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"gmtModified\"</span>, metric.getGmtModified().getTime())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"passQps\"</span>, metric.getPassQps())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"successQps\"</span>, metric.getSuccessQps())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"blockQps\"</span>, metric.getBlockQps())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"exceptionQps\"</span>, metric.getExceptionQps())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"rt\"</span>, metric.getRt())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"count\"</span>, metric.getCount())</span><br><span class=\"line\">                .addField(<span class=\"string\">\"resourceCode\"</span>, metric.getResourceCode())</span><br><span class=\"line\">                .build());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<p>其中：</p>\n<p>save、saveAll方法通过调用InfluxDBUtils.insert和InfluxDBInsertCallback回调方法，往sentinel_db库的sentinel_metric数据表写数据；</p>\n<p>saveAll方法不是循环调用save方法，而是在回调内部循环Iterable<metricentity> metrics处理，这样InfluxDBFactory.connect连接只打开关闭一次；</metricentity></p>\n<p>doSave方法中，.time(DateUtils.addHours(metric.getTimestamp(), 8).getTime(), TimeUnit.MILLISECONDS)</p>\n<p>因InfluxDB的UTC时间暂时没找到修改方法，所以这里time时间列加了8个小时时差；</p>\n<p>queryByAppAndResourceBetween、listResourcesOfApp里面的查询方法，使用InfluxDB提供的类sql语法，编写查询语句即可。</p>\n<ol start=\"2\">\n<li>注册Spring Bean,使用<code>@Qualifier</code>指定要使用的bean name</li>\n</ol>\n<p>在<code>com.alibaba.csp.sentinel.dashboard.controlle.MetricController</code>、``com.alibaba.csp.sentinel.dashboard.metric.MetricFetcher`类，找到metricStore属性，在@Autowired注解上面加上@Qualifier注解：</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Autowired</span></span><br><span class=\"line\"><span class=\"meta\">@Qualifier</span>(<span class=\"string\">\"influxDBMetricsRepository\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">private</span> MetricsRepository&lt;MetricEntity&gt; metricStore;</span><br></pre></td></tr></table></div></figure>\n<h1 id=\"验证\"><a class=\"markdownIt-Anchor\" href=\"SentinelInfluxDB改造#验证\"></a> 验证<a href=\"SentinelInfluxDB改造#验证\"></a></h1>\n<ol>\n<li>在需要的工程里接入Sentinel，并启动改造后的Sentinel dashboard</li>\n</ol>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mvn spring-boot:run [-Pdev]</span><br></pre></td></tr></table></div></figure>\n<p>证实项目正常启动，若否，通过git记录和上文核对问题并修正</p>\n<ol start=\"2\">\n<li>正常打开dashboard，确认有流量流入</li>\n<li>打开InfluxDB，发送HTTP请求查询<code>measurements</code></li>\n</ol>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[GET] http://influxdb.idc.hanyuu.demo:8086/query?pretty=true&amp;db=sentinel_db&amp;q=show measurements</span><br></pre></td></tr></table></div></figure>\n<p>证实measurement已被创建</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"results\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"statement_id\"</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"series\"</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"attr\">\"name\"</span>: <span class=\"string\">\"measurements\"</span>,</span><br><span class=\"line\">          <span class=\"attr\">\"columns\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"name\"</span></span><br><span class=\"line\">          ],</span><br><span class=\"line\">          <span class=\"attr\">\"values\"</span>: [</span><br><span class=\"line\">            [</span><br><span class=\"line\">              <span class=\"string\">\"sentinel_metric\"</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<ul>\n<li>查询最新三条记录</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[GET] http://influxdb.idc.hanyuu.demo:8086/query?pretty=true&amp;db=sentinel_db&amp;q=select * from sentinel_metric order by time limit 3</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"results\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"attr\">\"statement_id\"</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">      <span class=\"attr\">\"series\"</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          <span class=\"attr\">\"name\"</span>: <span class=\"string\">\"sentinel_metric\"</span>,</span><br><span class=\"line\">          <span class=\"attr\">\"columns\"</span>: [</span><br><span class=\"line\">            <span class=\"string\">\"time\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"app\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"blockQps\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"count\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"exceptionQps\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"gmtCreate\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"gmtModified\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"id\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"passQps\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"resource\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"resourceCode\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"rt\"</span>,</span><br><span class=\"line\">            <span class=\"string\">\"successQps\"</span></span><br><span class=\"line\">          ],</span><br><span class=\"line\">          <span class=\"attr\">\"values\"</span>: [</span><br><span class=\"line\">            [</span><br><span class=\"line\">              <span class=\"string\">\"2021-01-21T15:57:28Z\"</span>,</span><br><span class=\"line\">              <span class=\"string\">\"com.github.hanyuulu.demo.demo.DemoApplication\"</span>,</span><br><span class=\"line\">              <span class=\"number\">0</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span>,</span><br><span class=\"line\">              <span class=\"number\">0</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215851663</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215851663</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215862422</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span>,</span><br><span class=\"line\">              <span class=\"string\">\"/wait\"</span>,</span><br><span class=\"line\">              <span class=\"number\">47047204</span>,</span><br><span class=\"line\">              <span class=\"number\">19</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span></span><br><span class=\"line\">            ],</span><br><span class=\"line\">            [</span><br><span class=\"line\">              <span class=\"string\">\"2021-01-21T15:57:28Z\"</span>,</span><br><span class=\"line\">              <span class=\"string\">\"com.github.hanyuulu.demo.demo.DemoApplication\"</span>,</span><br><span class=\"line\">              <span class=\"number\">0</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span>,</span><br><span class=\"line\">              <span class=\"number\">0</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215851663</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215851663</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215862399</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span>,</span><br><span class=\"line\">              <span class=\"string\">\"LONG_TIME_CONTROLLER\"</span>,</span><br><span class=\"line\">              <span class=\"number\">1822368907</span>,</span><br><span class=\"line\">              <span class=\"number\">4</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span></span><br><span class=\"line\">            ],</span><br><span class=\"line\">            [</span><br><span class=\"line\">              <span class=\"string\">\"2021-01-21T15:57:29Z\"</span>,</span><br><span class=\"line\">              <span class=\"string\">\"com.github.hanyuulu.demo.demo.DemoApplication\"</span>,</span><br><span class=\"line\">              <span class=\"number\">0</span>,</span><br><span class=\"line\">              <span class=\"number\">1</span>,</span><br><span class=\"line\">              <span class=\"number\">0</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215851663</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215851663</span>,</span><br><span class=\"line\">              <span class=\"number\">1611215856013</span>,</span><br><span class=\"line\">              <span class=\"number\">2</span>,</span><br><span class=\"line\">              <span class=\"string\">\"/error\"</span>,</span><br><span class=\"line\">              <span class=\"number\">1442355001</span>,</span><br><span class=\"line\">              <span class=\"number\">44</span>,</span><br><span class=\"line\">              <span class=\"number\">2</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></div></figure>\n<h1 id=\"接入grafana\"><a class=\"markdownIt-Anchor\" href=\"SentinelInfluxDB改造#接入grafana\"></a> 接入Grafana<a href=\"SentinelInfluxDB改造#接入grafana\"></a></h1>\n<p>为了更直观的分析数据，我们接入Grafana进行可视化分析</p>\n<ol>\n<li>\n<p>通过Docker拉取安装Grafana镜像</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull grafana/grafana</span><br><span class=\"line\">docker run -d -p 3000:3000 --name grafana grafana/grafana</span><br></pre></td></tr></table></div></figure>\n</li>\n<li>\n<p>使用默认账户密码<code>admin</code>、<code>admin</code>登陆，创建dashboard，自行创建需要的图表即可，下面简单介绍下各个参数的含义</p>\n<table>\n<thead>\n<tr>\n<th>field</th>\n<th>note</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>time</td>\n<td>时间戳</td>\n</tr>\n<tr>\n<td>app</td>\n<td>接入应用[tag]</td>\n</tr>\n<tr>\n<td>resource</td>\n<td>资源名称[tag]</td>\n</tr>\n<tr>\n<td>resourceCode</td>\n<td>资源code</td>\n</tr>\n<tr>\n<td>id</td>\n<td>聚合id</td>\n</tr>\n<tr>\n<td>gmtCreate</td>\n<td>gmt创建时间</td>\n</tr>\n<tr>\n<td>gmtModified</td>\n<td>gmt修改时间</td>\n</tr>\n<tr>\n<td>count</td>\n<td>本次聚合的总条数</td>\n</tr>\n<tr>\n<td>successQps</td>\n<td>成功QPS</td>\n</tr>\n<tr>\n<td>passQps</td>\n<td>通过QPS</td>\n</tr>\n<tr>\n<td>blockQps</td>\n<td>阻拦QPS</td>\n</tr>\n<tr>\n<td>exceptionQPS</td>\n<td>异常QPS</td>\n</tr>\n<tr>\n<td>rt</td>\n<td>所有成功退出的计数</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"SentinelInfluxDB改造#参考文档\"></a> 参考文档</h1>\n</li>\n</ol>\n<ul>\n<li>\n<p><a href=\"https://www.cnblogs.com/cdfive2018/p/9914838.html\" target=\"_blank\" rel=\"noopener\">sentinel控制台监控数据持久化【InfluxDB】</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0\" target=\"_blank\" rel=\"noopener\">https://github.com/alibaba/Sentinel/wiki/控制台</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel-%E6%8E%A7%E5%88%B6%E5%8F%B0\" target=\"_blank\" rel=\"noopener\">https://github.com/alibaba/Sentinel/wiki/在生产环境中使用-Sentinel-控制台</a></p>\n</li>\n<li>\n<p><a href=\"https://docs.influxdata.com/influxdb/v1.6/introduction/getting-started/\" target=\"_blank\" rel=\"noopener\">https://docs.influxdata.com/influxdb/v1.6/introduction/getting-started/</a> InfluxDB官网文档</p>\n</li>\n<li>\n<p><a href=\"https://xtutu.gitbooks.io/influxdb-handbook/content/\" target=\"_blank\" rel=\"noopener\">https://xtutu.gitbooks.io/influxdb-handbook/content/</a> InfluxDB简明手册</p>\n</li>\n</ul>\n","next":{"title":"InfluxDB 配置用户权限（Docker）","link":"InfluxDB 配置用户权限（Docker）"},"plink":"hanyuulu.github.io/SentinelInfluxDB改造/","toc":[{"title":"<a class=\"markdownIt-Anchor\"></a> 前言","id":"前言","index":"1","children":[{"title":"<a class=\"markdownIt-Anchor\"></a> 准备工作","id":"准备工作","index":"1.1"}]},{"title":"<a class=\"markdownIt-Anchor\"></a> 接入InfluxDB","id":"接入influxdb","index":"2"},{"title":"<a class=\"markdownIt-Anchor\"></a> 验证","id":"验证","index":"3"},{"title":"<a class=\"markdownIt-Anchor\"></a> 接入Grafana","id":"接入grafana","index":"4"},{"title":"","id":"参考文档","index":"5"}],"copyright":{"author":"Hanyuu Lu","license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by/4.0/\">知识共享署名 4.0 国际许可协议</a>","published":"2021年1月22日","updated":"2021年3月12日"}}