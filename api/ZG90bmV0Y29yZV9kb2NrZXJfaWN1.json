{"title":".NET Core 应用打包和部署到docker上的一些注意事项","date":"2020-10-28T00:00:00.000Z","link":"dotnetcore_docker_icu","tags":[".NET Core","ASP .NET","Docker"],"categories":["programming"],"updated":"2021-03-12T08:22:58.542Z","content":"<p>[toc]</p>\n<h3 id=\"环境概要\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#环境概要\"></a> 环境概要<a href=\"dotnetcore_docker_icu#环境概要\"></a></h3>\n<p>本文档使用</p>\n<ul>\n<li>.NET Core 3.1.401 win-x64</li>\n<li>Docker Community win-x64\n<ul>\n<li>Docker Engine 19.03.13</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"打包\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#打包\"></a> 打包<a href=\"dotnetcore_docker_icu#打包\"></a></h3>\n<h4 id=\"自带依赖发布到目标平台\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#自带依赖发布到目标平台\"></a> 自带依赖发布到目标平台<a href=\"dotnetcore_docker_icu#自带依赖发布到目标平台\"></a></h4>\n<ul>\n<li>例子</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dotnet publish <span class=\"literal\">-r</span> linux<span class=\"literal\">-x64</span> -<span class=\"literal\">-configuration</span> Release</span><br></pre></td></tr></table></div></figure>\n<ul>\n<li>\n<p>说明</p>\n<ul>\n<li>\n<p>publish命令会自动restore依赖</p>\n</li>\n<li>\n<p>configuration分为<code>Debug</code>和<code>Release</code>，建议使用<code>Release</code>发布应用（并配置对应的配置文件）</p>\n</li>\n<li>\n<p>-r：要编译的目标平台，具体请参阅<a href=\"https://docs.microsoft.com/zh-cn/dotnet/core/rid-catalog\" target=\"_blank\" rel=\"noopener\">.NET Core 运行时标识符 (RID) 目录 | Microsoft Docs</a></p>\n<p>一些常用的RID如下</p>\n<blockquote>\n<ul>\n<li>\n<p>可移植（.NET Core 2.0 或更高版本）</p>\n<ul>\n<li>\n<p><code>win-x64</code></p>\n</li>\n<li>\n<p><code>win-x86</code></p>\n</li>\n<li>\n<p><code>win-arm</code></p>\n</li>\n<li>\n<p><code>win-arm64</code></p>\n</li>\n<li>\n<p><code>linux-x64</code>（大多数桌面发行版，如 CentOS、Debian、Fedora、Ubuntu 及派生版本）</p>\n</li>\n<li>\n<p><code>linux-musl-x64</code>（使用 <a href=\"https://wiki.musl-libc.org/projects-using-musl.html\" target=\"_blank\" rel=\"noopener\">musl</a> 的轻量级发行版，如 Alpine Linux）</p>\n</li>\n<li>\n<p><code>linux-arm</code>（在 ARM 上运行的 Linux 发行版本，如 Raspberry Pi Model 2 及更高版本上的 Raspbian）</p>\n</li>\n<li>\n<p><code>linux-arm64</code>（在 64 位 ARM 上运行的 Linux 发行版本，如 Raspberry Pi Model 3 及更高版本上的 Ubuntu 服务器 64 位）</p>\n</li>\n<li>\n<p><code>osx-x64</code>（最低 OS 版本为 macOS 10.12 Sierra）</p>\n</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"打包程序为单文件\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#打包程序为单文件\"></a> 打包程序为单文件<a href=\"dotnetcore_docker_icu#打包程序为单文件\"></a></h4>\n<p>添加参数<code>-p:PublishSingleFile=true</code></p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dotnet publish <span class=\"literal\">-r</span> linux<span class=\"literal\">-x64</span> -<span class=\"literal\">-configuration</span> Release <span class=\"literal\">-p</span>:PublishSingleFile=true</span><br></pre></td></tr></table></div></figure>\n<h4 id=\"裁剪未使用的依赖\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#裁剪未使用的依赖\"></a> 裁剪未使用的依赖<a href=\"dotnetcore_docker_icu#裁剪未使用的依赖\"></a></h4>\n<blockquote>\n<p>从 .NET Core 3.0 开始，SDK 作为预览功能提供。此功能可能会导致问题，如果发现问题请尝试不启用此参数</p>\n</blockquote>\n<p>添加参数<code>-p:PublishTrimmed=true</code></p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dotnet publish <span class=\"literal\">-r</span> linux<span class=\"literal\">-x64</span> -<span class=\"literal\">-configuration</span> Release <span class=\"literal\">-p</span>:PublishSingleFile=true <span class=\"literal\">-p</span>:PublishTrimmed=true</span><br></pre></td></tr></table></div></figure>\n<blockquote>\n<p>-p 参数也可写在配置文件中，请参阅<a href=\"https://docs.microsoft.com/zh-cn/dotnet/core/tools/dotnet-publish#msbuild\" target=\"_blank\" rel=\"noopener\">dotnet publish 命令 - .NET Core CLI | Microsoft Docs</a>和<a href=\"https://docs.microsoft.com/zh-cn/aspnet/core/host-and-deploy/visual-studio-publish-profiles?view=aspnetcore-3.1\" target=\"_blank\" rel=\"noopener\">用于 ASP.NET Core 应用部署的 Visual Studio 发布配置文件 (.pubxml) | Microsoft Docs</a></p>\n</blockquote>\n<h3 id=\"net-core-发布后在ubuntu基础镜像上运行的常见问题\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#net-core-发布后在ubuntu基础镜像上运行的常见问题\"></a> .NET Core 发布后在Ubuntu基础镜像上运行的常见问题<a href=\"dotnetcore_docker_icu#net-core-发布后在ubuntu基础镜像上运行的常见问题\"></a></h3>\n<ol>\n<li>\n<p>提示没有icu依赖</p>\n<p><a href=\"http://xn--icuASP-k02m.NET\" target=\"_blank\" rel=\"noopener\">icu是ASP.NET</a> Core在Linux系统上的全球化实现，Docker基础镜像默认无此依赖，需要在打包镜像时先安装依赖，参照<a href=\"https://docs.microsoft.com/zh-cn/dotnet/standard/globalization-localization/globalization-icu\" target=\"_blank\" rel=\"noopener\">全球化和 ICU | Microsoft Docs</a></p>\n</li>\n<li>\n<p>提示没有合适版本的libssl</p>\n<p><a href=\"http://xn--Ubuntulibssl-ng2tz61fwwnvu7bmq1bu0renfvu4bte1h.NET\" target=\"_blank\" rel=\"noopener\">Ubuntu基础镜像缺省libssl版本对.NET</a> Core 3不兼容</p>\n</li>\n</ol>\n<p>解决方案：参考如下Dockerfile，使用国内镜像安装依赖</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> ubuntu:latest</span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> ./KoroneLibrary/bin/Release/netcoreapp3.1/linux-x64/publish/  /</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> ./sources.list /etc/apt/sources.list</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> chmod 744 /KoroneLibrary &amp;&amp; apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install icu-devtools -y &amp;&amp; apt install libssl1.1 -y &amp;&amp; apt auto-remove -y &amp;&amp; apt clean -y</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">\"/KoroneLibrary\"</span>]</span></span><br><span class=\"line\"><span class=\"keyword\">VOLUME</span><span class=\"bash\"> [<span class=\"string\">\"/Lib\"</span>]</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">5000</span></span><br></pre></td></tr></table></div></figure>\n<h3 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"dotnetcore_docker_icu#参考文档\"></a> 参考文档<a href=\"dotnetcore_docker_icu#参考文档\"></a></h3>\n<ul>\n<li><a href=\"https://docs.microsoft.com/zh-cn/dotnet/core/tools/dotnet-publish\" target=\"_blank\" rel=\"noopener\">dotnet publish 命令 - .NET Core CLI | Microsoft Docs</a></li>\n</ul>\n","prev":{"title":"在Spring中获取当前环境字符串","link":"spring_profile_activate"},"next":{"title":"Python进程池、线程池和进程间通信实践参考","link":"thread_process_pool"},"plink":"hanyuulu.github.io/dotnetcore_docker_icu/","copyright":{"author":"Hanyuu Lu","license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by/4.0/\">知识共享署名 4.0 国际许可协议</a>","published":"2020年10月28日","updated":"2021年3月12日"}}