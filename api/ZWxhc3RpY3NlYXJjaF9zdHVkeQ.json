{"title":"Elastic Search 学习","date":"2020-11-20T00:00:00.000Z","link":"elasticsearch_study","tags":["Elastic Search"],"categories":["programming"],"updated":"2021-03-12T08:22:58.542Z","content":"<h2 id=\"elastic-search-学习\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#elastic-search-学习\"></a> Elastic Search 学习<a href=\"elasticsearch_study#elastic-search-学习\"></a></h2>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> elasticsearch <span class=\"keyword\">import</span> Elasticsearch <span class=\"keyword\">as</span> ES</span><br><span class=\"line\">es = ES(<span class=\"string\">'http://localhost'</span>,port = <span class=\"number\">9200</span>)</span><br></pre></td></tr></table></div></figure>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests <span class=\"keyword\">as</span> r</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">url</span><span class=\"params\">(src:str)</span>-&gt;str:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">f'http://localhost:9200<span class=\"subst\">&#123;src&#125;</span>?pretty=true'</span></span><br><span class=\"line\">p = &#123;<span class=\"string\">\"pretty\"</span>:<span class=\"string\">\"true\"</span>&#125;</span><br></pre></td></tr></table></div></figure>\n<blockquote>\n<p>本文档包含了从快速部署开始到一些较为高级的用法的演示和说明，使用环境是Windows，使用Power Shell作为命令行环境，在jupyter notebook中进行测试</p>\n</blockquote>\n<h2 id=\"快速部署docker\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#快速部署docker\"></a> 快速部署（Docker）<a href=\"elasticsearch_study#快速部署docker\"></a></h2>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装Elasticsearch</span></span><br><span class=\"line\">docker pull docker.elastic.co/elasticsearch/elasticsearch:<span class=\"number\">7.9</span>.<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"comment\"># 运行单节点</span></span><br><span class=\"line\">docker run <span class=\"literal\">-p</span> <span class=\"number\">9200</span>:<span class=\"number\">9200</span> <span class=\"literal\">-p</span> <span class=\"number\">9300</span>:<span class=\"number\">9300</span> <span class=\"literal\">-e</span> <span class=\"string\">\"discovery.type=single-node\"</span> docker.elastic.co/elasticsearch/elasticsearch:<span class=\"number\">7.9</span>.<span class=\"number\">3</span> -<span class=\"literal\">-name</span> elastic_search</span><br></pre></td></tr></table></div></figure>\n<ul>\n<li>测试cluster</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print(r.get(url(<span class=\"string\">'/'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;name&quot; : &quot;f0a5b2ffad4a&quot;,\n  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,\n  &quot;cluster_uuid&quot; : &quot;NIdw38XdQBi5rmtiroeIVA&quot;,\n  &quot;version&quot; : {\n    &quot;number&quot; : &quot;7.9.2&quot;,\n    &quot;build_flavor&quot; : &quot;default&quot;,\n    &quot;build_type&quot; : &quot;docker&quot;,\n    &quot;build_hash&quot; : &quot;d34da0ea4a966c4e49417f2da2f244e3e97b4e6e&quot;,\n    &quot;build_date&quot; : &quot;2020-09-23T00:45:33.626720Z&quot;,\n    &quot;build_snapshot&quot; : false,\n    &quot;lucene_version&quot; : &quot;8.6.2&quot;,\n    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,\n    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;\n  },\n  &quot;tagline&quot; : &quot;You Know, for Search&quot;\n}\n</code></pre>\n<h3 id=\"安装kibana\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#安装kibana\"></a> 安装Kibana<a href=\"elasticsearch_study#安装kibana\"></a></h3>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull docker.elastic.co/kibana/kibana:<span class=\"number\">7.9</span>.<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"comment\"># 启动容器并链接elasticsearch</span></span><br><span class=\"line\">docker run -<span class=\"literal\">-link</span> elastic_search:elasticsearch <span class=\"literal\">-p</span> <span class=\"number\">5601</span>:<span class=\"number\">5601</span> docker.elastic.co/kibana/kibana:<span class=\"number\">7.9</span>.<span class=\"number\">3</span></span><br><span class=\"line\"><span class=\"comment\"># 测试Kibana</span></span><br><span class=\"line\"><span class=\"comment\"># 浏览器能访问5601端口即可</span></span><br></pre></td></tr></table></div></figure>\n<h2 id=\"基本概念\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#基本概念\"></a> 基本概念<a href=\"elasticsearch_study#基本概念\"></a></h2>\n<h3 id=\"node-cluster\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#node-cluster\"></a> Node &amp; Cluster<a href=\"elasticsearch_study#node-cluster\"></a></h3>\n<p>Elastic 是一个分布式数据库，单个Elastic实例为一个节点（Node），若干节点组成一个集群（Cluster）。</p>\n<h3 id=\"index\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#index\"></a> Index<a href=\"elasticsearch_study#index\"></a></h3>\n<p>类似于SQL数据库的database,索引（Index）是数据管理的一级单位，<strong>index名必须小写</strong></p>\n<p>Elastic索引所有字段，经过处理后产生一个反向索引（Inverted Index）用以在查询的时候搜索文档。</p>\n<ul>\n<li>新建一个索引</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print(r.put(url(<span class=\"string\">'/todo'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;error&quot; : {\n    &quot;root_cause&quot; : [\n      {\n        &quot;type&quot; : &quot;resource_already_exists_exception&quot;,\n        &quot;reason&quot; : &quot;index [todo/BShbis0RR3aA-X3wdcD2cQ] already exists&quot;,\n        &quot;index_uuid&quot; : &quot;BShbis0RR3aA-X3wdcD2cQ&quot;,\n        &quot;index&quot; : &quot;todo&quot;\n      }\n    ],\n    &quot;type&quot; : &quot;resource_already_exists_exception&quot;,\n    &quot;reason&quot; : &quot;index [todo/BShbis0RR3aA-X3wdcD2cQ] already exists&quot;,\n    &quot;index_uuid&quot; : &quot;BShbis0RR3aA-X3wdcD2cQ&quot;,\n    &quot;index&quot; : &quot;todo&quot;\n  },\n  &quot;status&quot; : 400\n}\n</code></pre>\n<ul>\n<li>删除一个索引</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print(r.delete(url(<span class=\"string\">'/todo'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;acknowledged&quot; : true\n}\n</code></pre>\n<ul>\n<li>查阅Node下所有Index</li>\n</ul>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print(r.get(url(<span class=\"string\">'/_cat/indices'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>green  open .kibana-event-log-7.9.2-000001 6z4diegrSYusecVp-8YnJA 1 0     1  0   5.5kb   5.5kb\ngreen  open .apm-custom-link               70A0r6x_To2MvZXsyGUTlA 1 0     0  0    208b    208b\ngreen  open .kibana_task_manager_1         Bn7h59PXSQqqWaJT21idlw 1 0     6 68 137.9kb 137.9kb\ngreen  open .kibana-event-log-7.9.2-000002 KDsEyuhwR6K1pngNoseQag 1 0     1  0   5.5kb   5.5kb\ngreen  open .apm-agent-configuration       XhYtj6-qRpC8-TLAo85ZYg 1 0     0  0    208b    208b\ngreen  open kibana_sample_data_logs        0Ov2Tb15QYOHrSAhd5VbvQ 1 0 14074  0  10.3mb  10.3mb\nyellow open gb                             zgJK4tsDR96ok9yXBFfOBA 1 1     1  0     5kb     5kb\ngreen  open .async-search                  S6V9_mcIRO2ADOl3ZZB7kw 1 0     0  0    234b    234b\ngreen  open .kibana_1                      eYLHd8UzTcOupTc_QJRIEQ 1 0    73  0  10.4mb  10.4mb\nyellow open us                             w6zNSJ7uQta8gsbPnpkTUw 1 1     1  0     5kb     5kb\n</code></pre>\n<h3 id=\"type\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#type\"></a> Type<a href=\"elasticsearch_study#type\"></a></h3>\n<p>文档的虚拟的逻辑分组，可以用于过滤文档，一个索引下的文档应当具有相似的结构（Schema）</p>\n<h3 id=\"document\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#document\"></a> Document<a href=\"elasticsearch_study#document\"></a></h3>\n<p>文档（Document）类似SQL数据库里的一个记录（Record），一个索引由多个文档组成。</p>\n<h2 id=\"接口和功能说明\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#接口和功能说明\"></a> 接口和功能说明<a href=\"elasticsearch_study#接口和功能说明\"></a></h2>\n<h3 id=\"文档操作演示\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#文档操作演示\"></a> 文档操作演示<a href=\"elasticsearch_study#文档操作演示\"></a></h3>\n<blockquote>\n<p>尝试建立并查询一个索引，以此加深对Index，Type和Document的概念</p>\n</blockquote>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 新建一个doc</span></span><br><span class=\"line\">print(r.put(url(<span class=\"string\">'/todo/things/0'</span>),json=&#123;</span><br><span class=\"line\">    <span class=\"string\">'title'</span>:<span class=\"string\">'待办事项A'</span>,</span><br><span class=\"line\">    <span class=\"string\">'priority'</span>:<span class=\"number\">0.6</span>,</span><br><span class=\"line\">    <span class=\"string\">'date'</span>:<span class=\"string\">'2020-11-01'</span>,</span><br><span class=\"line\">    <span class=\"string\">'assignment'</span>:[<span class=\"string\">'aicy'</span>,<span class=\"string\">'rin'</span>]</span><br><span class=\"line\">&#125;).text)</span><br><span class=\"line\">print(r.put(url(<span class=\"string\">'/todo/things/1'</span>),json=&#123;</span><br><span class=\"line\">    <span class=\"string\">'title'</span>:<span class=\"string\">'待办事项B_backup'</span>,</span><br><span class=\"line\">    <span class=\"string\">'priority'</span>:<span class=\"number\">0.5</span>,</span><br><span class=\"line\">    <span class=\"string\">'date'</span>:<span class=\"string\">'2020-11-02'</span>,</span><br><span class=\"line\">    <span class=\"string\">'assignment'</span>:[<span class=\"string\">'hanyuu'</span>,<span class=\"string\">'rin'</span>]</span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;_index&quot; : &quot;todo&quot;,\n  &quot;_type&quot; : &quot;things&quot;,\n  &quot;_id&quot; : &quot;0&quot;,\n  &quot;_version&quot; : 1,\n  &quot;result&quot; : &quot;created&quot;,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 2,\n    &quot;successful&quot; : 1,\n    &quot;failed&quot; : 0\n  },\n  &quot;_seq_no&quot; : 0,\n  &quot;_primary_term&quot; : 1\n}\n\n{\n  &quot;_index&quot; : &quot;todo&quot;,\n  &quot;_type&quot; : &quot;things&quot;,\n  &quot;_id&quot; : &quot;1&quot;,\n  &quot;_version&quot; : 1,\n  &quot;result&quot; : &quot;created&quot;,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 2,\n    &quot;successful&quot; : 1,\n    &quot;failed&quot; : 0\n  },\n  &quot;_seq_no&quot; : 1,\n  &quot;_primary_term&quot; : 1\n}\n</code></pre>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print(r.post(url(<span class=\"string\">'/todo/things/'</span>),json=&#123;</span><br><span class=\"line\">    <span class=\"string\">'title'</span>:<span class=\"string\">'待办事项C'</span>,</span><br><span class=\"line\">    <span class=\"string\">'priority'</span>:<span class=\"number\">0.8</span>,</span><br><span class=\"line\">    <span class=\"string\">'date'</span>:<span class=\"string\">'2020-11-02'</span>,</span><br><span class=\"line\">    <span class=\"string\">'assignment'</span>:[<span class=\"string\">'aicy'</span>,<span class=\"string\">'rin'</span>]</span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;_index&quot; : &quot;todo&quot;,\n  &quot;_type&quot; : &quot;things&quot;,\n  &quot;_id&quot; : &quot;qLE2A3YBPtTv4vAuC6e7&quot;,\n  &quot;_version&quot; : 1,\n  &quot;result&quot; : &quot;created&quot;,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 2,\n    &quot;successful&quot; : 1,\n    &quot;failed&quot; : 0\n  },\n  &quot;_seq_no&quot; : 2,\n  &quot;_primary_term&quot; : 1\n}\n</code></pre>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询doc</span></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/things/0'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;_index&quot; : &quot;todo&quot;,\n  &quot;_type&quot; : &quot;things&quot;,\n  &quot;_id&quot; : &quot;0&quot;,\n  &quot;_version&quot; : 1,\n  &quot;_seq_no&quot; : 0,\n  &quot;_primary_term&quot; : 1,\n  &quot;found&quot; : true,\n  &quot;_source&quot; : {\n    &quot;title&quot; : &quot;待办事项A&quot;,\n    &quot;priority&quot; : 0.6,\n    &quot;date&quot; : &quot;2020-11-01&quot;,\n    &quot;assignment&quot; : [\n      &quot;aicy&quot;,\n      &quot;rin&quot;\n    ]\n  }\n}\n</code></pre>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查询schema</span></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;todo&quot; : {\n    &quot;aliases&quot; : { },\n    &quot;mappings&quot; : {\n      &quot;properties&quot; : {\n        &quot;assignment&quot; : {\n          &quot;type&quot; : &quot;text&quot;,\n          &quot;fields&quot; : {\n            &quot;keyword&quot; : {\n              &quot;type&quot; : &quot;keyword&quot;,\n              &quot;ignore_above&quot; : 256\n            }\n          }\n        },\n        &quot;date&quot; : {\n          &quot;type&quot; : &quot;date&quot;\n        },\n        &quot;priority&quot; : {\n          &quot;type&quot; : &quot;float&quot;\n        },\n        &quot;title&quot; : {\n          &quot;type&quot; : &quot;text&quot;,\n          &quot;fields&quot; : {\n            &quot;keyword&quot; : {\n              &quot;type&quot; : &quot;keyword&quot;,\n              &quot;ignore_above&quot; : 256\n            }\n          }\n        }\n      }\n    },\n    &quot;settings&quot; : {\n      &quot;index&quot; : {\n        &quot;creation_date&quot; : &quot;1606371641662&quot;,\n        &quot;number_of_shards&quot; : &quot;1&quot;,\n        &quot;number_of_replicas&quot; : &quot;1&quot;,\n        &quot;uuid&quot; : &quot;aKIUpjivSWGDCrgYoWUy0w&quot;,\n        &quot;version&quot; : {\n          &quot;created&quot; : &quot;7090299&quot;\n        },\n        &quot;provided_name&quot; : &quot;todo&quot;\n      }\n    }\n  }\n}\n</code></pre>\n<blockquote>\n<p>使用post可以不指定ip新增文档，elastic回返回一个随机字符串</p>\n<p>使用PUT，POST，GET，DELETE动词进行新增，更新，查询，删除操作</p>\n</blockquote>\n<h3 id=\"数据查询\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#数据查询\"></a> 数据查询<a href=\"elasticsearch_study#数据查询\"></a></h3>\n<h4 id=\"返回所有记录\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#返回所有记录\"></a> 返回所有记录<a href=\"elasticsearch_study#返回所有记录\"></a></h4>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/things/_search'</span>)).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;took&quot; : 3,\n  &quot;timed_out&quot; : false,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;skipped&quot; : 0,\n    &quot;failed&quot; : 0\n  },\n  &quot;hits&quot; : {\n    &quot;total&quot; : {\n      &quot;value&quot; : 0,\n      &quot;relation&quot; : &quot;eq&quot;\n    },\n    &quot;max_score&quot; : null,\n    &quot;hits&quot; : [ ]\n  }\n}\n</code></pre>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 轻量搜索</span></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/things/_search?q=title:\"待办事项B_backup\"'</span>),params = p).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;took&quot; : 287,\n  &quot;timed_out&quot; : false,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;skipped&quot; : 0,\n    &quot;failed&quot; : 0\n  },\n  &quot;hits&quot; : {\n    &quot;total&quot; : {\n      &quot;value&quot; : 0,\n      &quot;relation&quot; : &quot;eq&quot;\n    },\n    &quot;max_score&quot; : null,\n    &quot;hits&quot; : [ ]\n  }\n}\n</code></pre>\n<h4 id=\"全文搜索\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#全文搜索\"></a> 全文搜索<a href=\"elasticsearch_study#全文搜索\"></a></h4>\n<blockquote>\n<p>elastic使用DSL进行索引</p>\n</blockquote>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 搜索单字段</span></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">\"/todo/things/_search\"</span>),json = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"query\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"match\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"title\"</span>: <span class=\"string\">\"待办事项\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"from\"</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">    <span class=\"string\">\"size\"</span>: <span class=\"number\">10</span></span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;took&quot; : 22,\n  &quot;timed_out&quot; : false,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;skipped&quot; : 0,\n    &quot;failed&quot; : 0\n  },\n  &quot;hits&quot; : {\n    &quot;total&quot; : {\n      &quot;value&quot; : 3,\n      &quot;relation&quot; : &quot;eq&quot;\n    },\n    &quot;max_score&quot; : 0.53412557,\n    &quot;hits&quot; : [\n      {\n        &quot;_index&quot; : &quot;todo&quot;,\n        &quot;_type&quot; : &quot;things&quot;,\n        &quot;_id&quot; : &quot;0&quot;,\n        &quot;_score&quot; : 0.53412557,\n        &quot;_source&quot; : {\n          &quot;title&quot; : &quot;待办事项A&quot;,\n          &quot;priority&quot; : 0.6,\n          &quot;date&quot; : &quot;2020-11-01&quot;,\n          &quot;assignment&quot; : [\n            &quot;aicy&quot;,\n            &quot;rin&quot;\n          ]\n        }\n      },\n      {\n        &quot;_index&quot; : &quot;todo&quot;,\n        &quot;_type&quot; : &quot;things&quot;,\n        &quot;_id&quot; : &quot;1&quot;,\n        &quot;_score&quot; : 0.53412557,\n        &quot;_source&quot; : {\n          &quot;title&quot; : &quot;待办事项B_backup&quot;,\n          &quot;priority&quot; : 0.5,\n          &quot;date&quot; : &quot;2020-11-02&quot;,\n          &quot;assignment&quot; : [\n            &quot;hanyuu&quot;,\n            &quot;rin&quot;\n          ]\n        }\n      },\n      {\n        &quot;_index&quot; : &quot;todo&quot;,\n        &quot;_type&quot; : &quot;things&quot;,\n        &quot;_id&quot; : &quot;qLE2A3YBPtTv4vAuC6e7&quot;,\n        &quot;_score&quot; : 0.53412557,\n        &quot;_source&quot; : {\n          &quot;title&quot; : &quot;待办事项C&quot;,\n          &quot;priority&quot; : 0.8,\n          &quot;date&quot; : &quot;2020-11-02&quot;,\n          &quot;assignment&quot; : [\n            &quot;aicy&quot;,\n            &quot;rin&quot;\n          ]\n        }\n      }\n    ]\n  }\n}\n</code></pre>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 搜索多字段</span></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/things/_search'</span>),json = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"query\"</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">\"bool\"</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">\"must\"</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">\"multi_match\"</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">\"query\"</span>:<span class=\"string\">\"hanyuu\"</span>,</span><br><span class=\"line\">                <span class=\"string\">\"fields\"</span>:[</span><br><span class=\"line\">                    <span class=\"string\">\"title\"</span>,<span class=\"string\">\"assignment\"</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"string\">\"should\"</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">\"range\"</span>:&#123;</span><br><span class=\"line\">                    <span class=\"string\">\"priority\"</span>:&#123;</span><br><span class=\"line\">                        <span class=\"string\">\"gt\"</span>:<span class=\"number\">0.2</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;took&quot; : 2,\n  &quot;timed_out&quot; : false,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;skipped&quot; : 0,\n    &quot;failed&quot; : 0\n  },\n  &quot;hits&quot; : {\n    &quot;total&quot; : {\n      &quot;value&quot; : 1,\n      &quot;relation&quot; : &quot;eq&quot;\n    },\n    &quot;max_score&quot; : 1.9808291,\n    &quot;hits&quot; : [\n      {\n        &quot;_index&quot; : &quot;todo&quot;,\n        &quot;_type&quot; : &quot;things&quot;,\n        &quot;_id&quot; : &quot;1&quot;,\n        &quot;_score&quot; : 1.9808291,\n        &quot;_source&quot; : {\n          &quot;title&quot; : &quot;待办事项B_backup&quot;,\n          &quot;priority&quot; : 0.5,\n          &quot;date&quot; : &quot;2020-11-02&quot;,\n          &quot;assignment&quot; : [\n            &quot;hanyuu&quot;,\n            &quot;rin&quot;\n          ]\n        }\n      }\n    ]\n  }\n}\n</code></pre>\n<h3 id=\"多条件搜索逻辑运算\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#多条件搜索逻辑运算\"></a> 多条件搜索逻辑运算<a href=\"elasticsearch_study#多条件搜索逻辑运算\"></a></h3>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 与逻辑</span></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/things/_search'</span>),json = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"query\"</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">\"bool\"</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">\"must\"</span>:[</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">\"match\"</span>:&#123;</span><br><span class=\"line\">                        <span class=\"string\">\"title\"</span>:<span class=\"string\">\"待办事项\"</span></span><br><span class=\"line\">                    &#125;,</span><br><span class=\"line\">                    <span class=\"string\">\"match\"</span>:</span><br><span class=\"line\">                    &#123;</span><br><span class=\"line\">                        <span class=\"string\">\"priority\"</span>: <span class=\"number\">0.5</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;took&quot; : 6,\n  &quot;timed_out&quot; : false,\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;skipped&quot; : 0,\n    &quot;failed&quot; : 0\n  },\n  &quot;hits&quot; : {\n    &quot;total&quot; : {\n      &quot;value&quot; : 1,\n      &quot;relation&quot; : &quot;eq&quot;\n    },\n    &quot;max_score&quot; : 1.0,\n    &quot;hits&quot; : [\n      {\n        &quot;_index&quot; : &quot;todo&quot;,\n        &quot;_type&quot; : &quot;things&quot;,\n        &quot;_id&quot; : &quot;1&quot;,\n        &quot;_score&quot; : 1.0,\n        &quot;_source&quot; : {\n          &quot;title&quot; : &quot;待办事项B_backup&quot;,\n          &quot;priority&quot; : 0.5,\n          &quot;date&quot; : &quot;2020-11-02&quot;,\n          &quot;assignment&quot; : [\n            &quot;hanyuu&quot;,\n            &quot;rin&quot;\n          ]\n        }\n      }\n    ]\n  }\n}\n</code></pre>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># SQL</span></span><br><span class=\"line\">print(r.post(url(<span class=\"string\">'/_sql'</span>),params = &#123;<span class=\"string\">\"format\"</span>:<span class=\"string\">\"txt\"</span>&#125;,json = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"query\"</span>:<span class=\"string\">\"select title,priority from todo where priority&gt;0\"</span></span><br><span class=\"line\">&#125;).text)</span><br><span class=\"line\">print(r.post(url(<span class=\"string\">'/_sql'</span>),json = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"query\"</span>:<span class=\"string\">\"select title,priority from todo where priority&gt;0\"</span></span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>     title     |     priority     \n---------------+------------------\nå¾\n</code></pre>\n<p>åäºé¡¹A          |0.6000000238418579<br>\nå¾<br>\nåäºé¡¹B_backup   |0.5<br>\nå¾<br>\nåäºé¡¹C          |0.800000011920929</p>\n<pre><code>{\n  &quot;columns&quot; : [\n    {\n      &quot;name&quot; : &quot;title&quot;,\n      &quot;type&quot; : &quot;text&quot;\n    },\n    {\n      &quot;name&quot; : &quot;priority&quot;,\n      &quot;type&quot; : &quot;float&quot;\n    }\n  ],\n  &quot;rows&quot; : [\n    [\n      &quot;待办事项A&quot;,\n      0.6000000238418579\n    ],\n    [\n      &quot;待办事项B_backup&quot;,\n      0.5\n    ],\n    [\n      &quot;待办事项C&quot;,\n      0.800000011920929\n    ]\n  ]\n}\n</code></pre>\n<h3 id=\"合法性和错误提示以及合法解释\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#合法性和错误提示以及合法解释\"></a> 合法性和错误提示以及合法解释<a href=\"elasticsearch_study#合法性和错误提示以及合法解释\"></a></h3>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">print(r.get(url(<span class=\"string\">'/todo/things/_validate/query'</span>),params = &#123;<span class=\"string\">\"explain\"</span>:<span class=\"string\">\"true\"</span>&#125;,json = &#123;</span><br><span class=\"line\">        <span class=\"string\">\"query\"</span>:&#123;</span><br><span class=\"line\">        <span class=\"string\">\"bool\"</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">\"must\"</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">\"multi_match\"</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">\"query\"</span>:<span class=\"string\">\"hanyuu\"</span>,</span><br><span class=\"line\">                <span class=\"string\">\"fields\"</span>:[</span><br><span class=\"line\">                    <span class=\"string\">\"title\"</span>,<span class=\"string\">\"assignment\"</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            <span class=\"string\">\"should\"</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">\"range\"</span>:&#123;</span><br><span class=\"line\">                    <span class=\"string\">\"priority\"</span>:&#123;</span><br><span class=\"line\">                        <span class=\"string\">\"gt\"</span>:<span class=\"number\">0.2</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;).text)</span><br></pre></td></tr></table></div></figure>\n<pre><code>{\n  &quot;_shards&quot; : {\n    &quot;total&quot; : 1,\n    &quot;successful&quot; : 1,\n    &quot;failed&quot; : 0\n  },\n  &quot;valid&quot; : true,\n  &quot;explanations&quot; : [\n    {\n      &quot;index&quot; : &quot;todo&quot;,\n      &quot;valid&quot; : true,\n      &quot;explanation&quot; : &quot;+(+(assignment:hanyuu | title:hanyuu) priority:[0.20000002 TO Infinity]) #*:*&quot;\n    }\n  ]\n}\n</code></pre>\n<h3 id=\"排序与相关性\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#排序与相关性\"></a> 排序与相关性<a href=\"elasticsearch_study#排序与相关性\"></a></h3>\n<h3 id=\"elastic-search中的数据结构\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#elastic-search中的数据结构\"></a> Elastic Search中的数据结构<a href=\"elasticsearch_study#elastic-search中的数据结构\"></a></h3>\n<div class=\"article-bounded\"><div class=\"article-table\"><table>\n<thead>\n<tr>\n<th>数据结构</th>\n<th>优缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>排序列表Array/List</td>\n<td>使用二分法查找，不平衡</td>\n</tr>\n<tr>\n<td>HashMap/TreeMap</td>\n<td>性能高，内存消耗大，几乎是原始数据的三倍</td>\n</tr>\n<tr>\n<td>Skip List</td>\n<td>跳跃表，可快速查找词语，在lucene、redis、Hbase等均有实现。相对于TreeMap等结构，特别适合高并发场景（<a href=\"http://kenby.iteye.com/blog/1187303\" target=\"_blank\" rel=\"noopener\">Skip List介绍</a>）</td>\n</tr>\n<tr>\n<td>Trie</td>\n<td>适合英文词典，如果系统中存在大量字符串且这些字符串基本没有公共前缀，则相应的trie树将非常消耗内存（<a href=\"http://dongxicheng.org/structure/trietree/\" target=\"_blank\" rel=\"noopener\">数据结构之trie树</a>）</td>\n</tr>\n<tr>\n<td>Double Array Trie</td>\n<td>适合做中文词典，内存占用小，很多分词工具均采用此种算法（<a href=\"http://blog.csdn.net/zhoubl668/article/details/6957830\" target=\"_blank\" rel=\"noopener\">深入双数组Trie</a>）</td>\n</tr>\n<tr>\n<td>Ternary Search Tree</td>\n<td>三叉树，每一个node有3个节点，兼具省空间和查询快的优点（<a href=\"http://www.drdobbs.com/database/ternary-search-trees/184410528\" target=\"_blank\" rel=\"noopener\">Ternary Search Tree</a>）</td>\n</tr>\n<tr>\n<td>Finite State Transducers (FST)</td>\n<td>一种有限状态转移机，Lucene 4有开源实现，并大量使用</td>\n</tr>\n</tbody>\n</table></div></div>\n<h3 id=\"kibana\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#kibana\"></a> Kibana<a href=\"elasticsearch_study#kibana\"></a></h3>\n<h2 id=\"参考文档\"><a class=\"markdownIt-Anchor\" href=\"elasticsearch_study#参考文档\"></a> 参考文档<a href=\"elasticsearch_study#参考文档\"></a></h2>\n<ul>\n<li>Elasticsearch: The Definitive Guide by Clinton Gormley and Zachary Tong (O’Reilly). Copyright 2015 Elasticsearch BV, 978-1-449-35854-9。</li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html\" target=\"_blank\" rel=\"noopener\">Install Elasticsearch with Docker</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/32843298\" target=\"_blank\" rel=\"noopener\">全文搜索引擎 Elasticsearch 入门教程 - 知乎 (zhihu.com)</a></li>\n<li><a href=\"https://blog.csdn.net/whichard/article/details/90753727\" target=\"_blank\" rel=\"noopener\">ElasticSearch中的数据结构</a></li>\n</ul>\n","prev":{"title":"数据结构-跳表（Skip List）","link":"skip_list"},"next":{"title":"在Spring中获取当前环境字符串","link":"spring_profile_activate"},"plink":"hanyuulu.github.io/elasticsearch_study/","toc":[{"title":"<a class=\"markdownIt-Anchor\"></a> Elastic Search 学习","id":"elastic-search-学习","index":"1"},{"title":"<a class=\"markdownIt-Anchor\"></a> 快速部署（Docker）","id":"快速部署docker","index":"2","children":[{"title":"<a class=\"markdownIt-Anchor\"></a> 安装Kibana","id":"安装kibana","index":"2.1"}]},{"title":"<a class=\"markdownIt-Anchor\"></a> 基本概念","id":"基本概念","index":"3","children":[{"title":"<a class=\"markdownIt-Anchor\"></a> Node &amp; Cluster","id":"node-cluster","index":"3.1"},{"title":"<a class=\"markdownIt-Anchor\"></a> Index","id":"index","index":"3.2"},{"title":"<a class=\"markdownIt-Anchor\"></a> Type","id":"type","index":"3.3"},{"title":"<a class=\"markdownIt-Anchor\"></a> Document","id":"document","index":"3.4"}]},{"title":"<a class=\"markdownIt-Anchor\"></a> 接口和功能说明","id":"接口和功能说明","index":"4","children":[{"title":"<a class=\"markdownIt-Anchor\"></a> 文档操作演示","id":"文档操作演示","index":"4.1"},{"title":"<a class=\"markdownIt-Anchor\"></a> 数据查询","id":"数据查询","index":"4.2","children":[{"title":"<a class=\"markdownIt-Anchor\"></a> 返回所有记录","id":"返回所有记录","index":"4.2.1"},{"title":"<a class=\"markdownIt-Anchor\"></a> 全文搜索","id":"全文搜索","index":"4.2.2"}]},{"title":"<a class=\"markdownIt-Anchor\"></a> 多条件搜索逻辑运算","id":"多条件搜索逻辑运算","index":"4.3"},{"title":"<a class=\"markdownIt-Anchor\"></a> 合法性和错误提示以及合法解释","id":"合法性和错误提示以及合法解释","index":"4.4"},{"title":"<a class=\"markdownIt-Anchor\"></a> 排序与相关性","id":"排序与相关性","index":"4.5"},{"title":"<a class=\"markdownIt-Anchor\"></a> Elastic Search中的数据结构","id":"elastic-search中的数据结构","index":"4.6"},{"title":"<a class=\"markdownIt-Anchor\"></a> Kibana","id":"kibana","index":"4.7"}]},{"title":"<a class=\"markdownIt-Anchor\"></a> 参考文档","id":"参考文档","index":"5"}],"copyright":{"author":"Hanyuu Lu","license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by/4.0/\">知识共享署名 4.0 国际许可协议</a>","published":"2020年11月20日","updated":"2021年3月12日"}}