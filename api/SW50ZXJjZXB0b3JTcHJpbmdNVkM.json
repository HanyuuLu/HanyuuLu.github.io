{"title":"Spring MVC 拦截器规则的“例外”问题","date":"2021-01-17T00:00:00.000Z","link":"InterceptorSpringMVC","tags":["Java"],"categories":["Programming"],"updated":"2021-03-12T08:22:58.406Z","content":"<h2 id=\"问题描述\"><a class=\"markdownIt-Anchor\" href=\"InterceptorSpringMVC#问题描述\"></a> 问题描述<a href=\"InterceptorSpringMVC#问题描述\"></a></h2>\n<p>在一个Spring boot 1.5.x工程（业务逻辑，URL等均已变更成不影响问题描述和解决但是和原工程毫无关系）中，我们有如下几个Controller的URL</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SALARY_IMPORT_URL = <span class=\"string\">\"/api/hr/salary/import\"</span></span><br><span class=\"line\">SALARY_EXPORT_URL = <span class=\"string\">\"/api/hr/salary/export\"</span></span><br><span class=\"line\"># 其他URL</span><br></pre></td></tr></table></div></figure>\n<p>由于一些原因，我们的项目中使用了拦截器（用于校验登录信息），原拦截逻辑如下：</p>\n<ol>\n<li>默认拦截所有URL</li>\n<li>所有<code>&quot;/api&quot;</code>开头的URL添加例外</li>\n</ol>\n<p>因为业务需要，我们需要校验访问<code>SALARY_IMPORT_URL</code>和<code>SALARY_EXPORT_URL</code>URL的权限，所以新的拦截逻辑应当如下：</p>\n<ol>\n<li>默认拦截所有URL</li>\n<li>所有<code>&quot;/api&quot;</code>开头的URL添加例外</li>\n<li><em><strong><code>&quot;/api/hr/salary/import&quot;</code>和<code>&quot;/api/hr/salary/export&quot;</code>需要拦截</strong></em></li>\n</ol>\n<p>显然，逻辑3和逻辑2有干涉</p>\n<p>原代码</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">interceptorRegistry.addInterceptor(loginInterceptor)</span><br><span class=\"line\">    .addPathPatterns(<span class=\"string\">\"/**\"</span>)</span><br><span class=\"line\">    .excludePathPatterns(<span class=\"string\">\"/api/**\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">interceptorRegistry.addInterceptor(loginInterceptor).addPathPatterns(whiteList);</span><br></pre></td></tr></table></div></figure>\n<p>一开始的想法</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SALARY_IMPORT_URL = <span class=\"string\">\"/api/hr/salary/import\"</span></span><br><span class=\"line\">SALARY_EXPORT_URL = <span class=\"string\">\"/api/hr/salary/export\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">interceptorRegistry.addInterceptor(loginInterceptor)</span><br><span class=\"line\">    .addPathPatterns(<span class=\"string\">\"/**\"</span>)</span><br><span class=\"line\">    .excludePathPatterns(<span class=\"string\">\"/api/**\"</span>)</span><br><span class=\"line\">    .addPathPatterns(SALARY_IMPORT_URL)</span><br><span class=\"line\">    .addPathPatterns(SALARY_EXPORT_URL);</span><br><span class=\"line\"></span><br><span class=\"line\">interceptorRegistry.addInterceptor(loginInterceptor).addPathPatterns(whiteList);</span><br></pre></td></tr></table></div></figure>\n<p>然而这两个URL依然没有被拦截，通过多方查证，在同事的帮助下，终于抽干了脑子里的水。</p>\n<p>添加后的代码</p>\n<figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SALARY_IMPORT_URL = <span class=\"string\">\"/api/hr/salary/import\"</span></span><br><span class=\"line\">SALARY_EXPORT_URL = <span class=\"string\">\"/api/hr/salary/export\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">interceptorRegistry.addInterceptor(loginInterceptor)</span><br><span class=\"line\">    .addPathPatterns(<span class=\"string\">\"/**\"</span>)</span><br><span class=\"line\">    .excludePathPatterns(<span class=\"string\">\"/api/**\"</span>);</span><br><span class=\"line\">interceptorRegistry.addInterceptor(loginInterceptor).addPathPatterns(SALARY_IMPORT_URL,SALARY_EXPORT_URL);</span><br></pre></td></tr></table></div></figure>\n<p>成功添加了“例外”。</p>\n<p>一些基本原理之类的之后补，太晚了要睡觉了~</p>\n<h2 id=\"参考资料\"><a class=\"markdownIt-Anchor\" href=\"InterceptorSpringMVC#参考资料\"></a> 参考资料<a href=\"InterceptorSpringMVC#参考资料\"></a></h2>\n<ol>\n<li><a href=\"https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-interceptors\" target=\"_blank\" rel=\"noopener\">Spring doc</a></li>\n</ol>\n","prev":{"title":"InfluxDB 配置用户权限（Docker）","link":"InfluxDB 配置用户权限（Docker）"},"next":{"title":"数据结构-跳表（Skip List）","link":"skip_list"},"plink":"hanyuulu.github.io/InterceptorSpringMVC/","toc":[{"title":"<a class=\"markdownIt-Anchor\"></a> 问题描述","id":"问题描述","index":"1"},{"title":"<a class=\"markdownIt-Anchor\"></a> 参考资料","id":"参考资料","index":"2"}],"copyright":{"author":"Hanyuu Lu","license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by/4.0/\">知识共享署名 4.0 国际许可协议</a>","published":"2021年1月17日","updated":"2021年3月12日"}}